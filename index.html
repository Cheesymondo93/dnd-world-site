<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Enter the Lich’s Domain</title>
<style>
  :root { --green:#10b981; --green2:#34d399; --eye:rgba(56,189,248,.65); }
  *{box-sizing:border-box} html,body{height:100%;margin:0}
  body{background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial}
  .screen{position:fixed;inset:0;min-height:100dvh;background:#000;overflow:hidden}
  .lich{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:translateY(0);transition:transform .6s ease-in,opacity .6s ease-in}
  .veil{position:absolute;inset:0;background:#000;pointer-events:none}
  .vignette{position:absolute;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,.7),rgba(0,0,0,.3),rgba(0,0,0,.8))}
  .glow{position:absolute;inset:0;mix-blend-mode:screen;background:radial-gradient(ellipse at center,var(--eye),transparent 45%);opacity:.15;transition:opacity .1s linear}
  .centre{position:relative;z-index:2;min-height:100dvh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:0 24px}
  h1{margin:0;font-weight:800;font-size:clamp(32px,4vw,64px);text-shadow:0 2px 12px rgba(0,0,0,.5)}
  .drag{
    user-select:none;background:var(--green);border-radius:9999px;padding:14px 28px;
    box-shadow:0 12px 30px rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);font-weight:700;
    display:inline-block;transform:translateY(var(--y,0px));transition:transform .2s ease-out;
    cursor:grab;touch-action:none /* important: only the button suppresses scrolling */
  }
  .hint{font-size:12px;opacity:.85}
  .bar{height:4px;background:rgba(0,0,0,.4);border-radius:9999px;margin-top:6px;width:100%}
  .bar>span{display:block;height:100%;width:0;background:var(--green2);border-radius:9999px;transition:width .06s linear}
  .row{margin-top:18px;display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
  .btn{background:#0ea5e9;color:#fff;padding:8px 12px;border-radius:8px;border:0}
  .btn[disabled]{background:#475569}
  .chip{background:#4f46e5;padding:2px 8px;border-radius:9999px;font-size:12px}
  code{background:rgba(255,255,255,.1);padding:2px 6px;border-radius:4px}
</style>
</head>
<body>
<main class="screen">
  <!-- Your PNG -->
  <img id="lich" class="lich" src="assets/lich.png" alt="Lich"
       onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1612036782180-6f0b6d1a9fea?q=80&w=1920&auto=format&fit=crop';">
  <div id="veil" class="veil" style="opacity:1"></div>
  <div id="glow" class="glow"></div>
  <div class="vignette"></div>

  <div class="centre">
    <h1>Enter the Lich’s Domain</h1>
    <p style="margin-top:12px;opacity:.9">Drag the sigil slowly or speak the passphrase.</p>

    <div style="margin-top:24px">
      <div id="drag" class="drag">
        Hold &amp; drag down to enter
        <div class="hint">(clicking or yanking fails)</div>
        <div class="bar"><span id="prog"></span></div>
      </div>
    </div>

    <div class="row">
      <button id="micBtn" class="btn">Use microphone</button>
      <span class="chip">Passphrase: <code>Men To Rule, Beast To Serve</code></span>
      <span style="font-size:12px;opacity:.9">Heard: <code id="heard">—</code></span>
      <span id="srStatus" style="font-size:12px;opacity:.9"></span>
    </div>
  </div>
</main>

<script>
  // -------- Config: reachable drag & anti-swipe gates --------
  const PASSPHRASE = "Men To Rule, Beast To Serve";
  let TARGET    = Math.round(Math.min(220, window.innerHeight * 0.33)); // total travel
  let UNLOCK_AT = Math.round(TARGET * 0.70);                             // success threshold
  const FAST_VY = 1200;   // px/s instant swipe threshold
  const MIN_DRAG_MS = 550; // must take at least this long

  addEventListener('resize', () => {
    TARGET    = Math.round(Math.min(220, innerHeight * 0.33));
    UNLOCK_AT = Math.round(TARGET * 0.70);
    setY(y);
  });

  // -------- Elements --------
  const drag = document.getElementById('drag');
  const prog = document.getElementById('prog');
  const veil = document.getElementById('veil');
  const glow = document.getElementById('glow');
  const lich = document.getElementById('lich');
  const heardEl = document.getElementById('heard');
  const micBtn = document.getElementById('micBtn');
  const srStatus = document.getElementById('srStatus');

  // -------- State --------
  let dragging=false, unlocking=false;
  let start={t:0,x:0,y:0}, last={t:0,y:0}, y=0;

  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  function setY(n){
    y = clamp(n, 0, TARGET);
    drag.style.setProperty('--y', y+'px');
    const p = y / TARGET;
    prog.style.width = (p*100)+'%';
    veil.style.opacity = (1 - p).toFixed(3);
    glow.style.opacity = (0.15 + 0.8*p).toFixed(3);
  }
  function flashEyes(){
    const prev=parseFloat(glow.style.opacity)||0.15;
    glow.style.opacity=1; setTimeout(()=>glow.style.opacity=prev,220);
  }
  function unlock(){
    if (unlocking) return;
    unlocking = true;
    lich.style.transform = 'translateY(-1200px)';
    setTimeout(()=>{ window.location.assign('./Map.html'); }, 600); // change to './map.html' if your file is lowercase
  }

  // -------- Drag handlers --------
  function down(e){
    dragging=true; drag.style.transition='none';
    const t = e.touches?.[0] || e;
    start={t:performance.now(),x:t.clientX,y:t.clientY};
    last ={t:performance.now(),y:t.clientY};
  }
  function move(e){
    if(!dragging) return;
    const t = e.touches?.[0] || e;
    const dy = t.clientY - start.y; setY(dy);
    last={t:performance.now(),y:t.clientY};
  }
  function up(e){
    const t = e.changedTouches?.[0] || e;
    if(!dragging){ flashEyes(); return; }
    dragging=false;

    const dt  = performance.now() - start.t; // total drag time
    const tiny = dt < 220 && Math.abs(t.clientX-start.x)<6 && Math.abs(t.clientY-start.y)<6;
    if (tiny){ flashEyes(); setY(0); return; }

    const dtv = (performance.now() - last.t) || 1;
    const vy  = ((t.clientY - last.y) / dtv) * 1000;

    // Must be slow enough and long enough
    if (vy > FAST_VY || dt < MIN_DRAG_MS){ flashEyes(); setY(0); return; }

    if (y >= UNLOCK_AT) unlock();
    else { drag.style.transition='transform .2s ease-out'; setY(0); }
  }

  drag.addEventListener('pointerdown', down);
  drag.addEventListener('pointermove', move);
  drag.addEventListener('pointerup',   up);
  drag.addEventListener('touchstart', down, {passive:false});
  drag.addEventListener('touchmove',  move, {passive:false});
  drag.addEventListener('touchend',   up,   {passive:false});
  drag.addEventListener('click', e=>{ e.preventDefault(); flashEyes(); });

  // -------- Speech recognition (with fuzzy match) --------
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    micBtn.textContent = 'Speech not supported';
    micBtn.disabled = true;
    srStatus.textContent = '(Use Chrome/Edge over HTTPS)';
  }

  const normalise = s => (s||'')
    .toLowerCase().replace(/[’']/g,"'")
    .replace(/[^a-z0-9', ]+/g,'').replace(/\s+/g,' ').trim();

  function levenshtein(a,b){
    const m=a.length,n=b.length;
    const d=Array.from({length:m+1},(_,i)=>Array(n+1).fill(0));
    for(let i=0;i<=m;i++) d[i][0]=i; for(let j=0;j<=n;j++) d[0][j]=j;
    for(let i=1;i<=m;i++) for(let j=1;j<=n;j++){
      const c=a[i-1]===b[j-1]?0:1;
      d[i][j]=Math.min(d[i-1][j]+1,d[i][j-1]+1,d[i-1][j-1]+c);
    }
    return d[m][n];
  }

  const PASS_N = normalise(PASSPHRASE);
  function closeEnough(spoken){
    if (!spoken) return false;
    if (spoken === PASS_N) return true;
    if (spoken.replace(/,/g,'') === PASS_N.replace(/,/g,'')) return true;
    const d = levenshtein(spoken, PASS_N);
    const sim = 1 - d / Math.max(spoken.length, PASS_N.length);
    return sim >= 0.85 || d <= 3;
  }

  let listening=false;
  micBtn.addEventListener('click', async ()=>{
    if (!SR || listening) return;
    listening=true; micBtn.textContent='Listening…'; heardEl.textContent='…'; srStatus.textContent='Requesting microphone…';

    try { await navigator.mediaDevices?.getUserMedia?.({ audio:true }); } catch(_){}
    const rec = new SR();
    rec.lang='en-GB';
    rec.interimResults=true;
    rec.continuous=false;
    rec.maxAlternatives=1;

    rec.onstart  = ()=>{ srStatus.textContent='Listening'; };
    rec.onresult = (e)=>{
      let text=''; for(let i=e.resultIndex;i<e.results.length;i++){ text+=e.results[i][0].transcript; }
      const n = normalise(text);
      heardEl.textContent = n || '—';
      if (e.results[e.results.length-1].isFinal){
        listening=false; micBtn.textContent='Use microphone'; srStatus.textContent='Final';
        if (closeEnough(n)) unlock(); else flashEyes();
      }
    };
    rec.onerror = (ev)=>{ listening=false; micBtn.textContent='Use microphone'; srStatus.textContent='Mic error: '+(ev.error||'unknown'); };
    rec.onend   = ()=>{ listening=false; micBtn.textContent='Use microphone'; if(heardEl.textContent==='…') heardEl.textContent='—'; if(!srStatus.textContent) srStatus.textContent='Ended'; };

    try { rec.start(); } catch(err){ listening=false; micBtn.textContent='Use microphone'; srStatus.textContent='Start failed'; }
  });
</script>
</body>
</html>
